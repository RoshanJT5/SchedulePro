{% extends "base.html" %}

{% block title %}Faculty - Plansphere.ai{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-person-badge"></i> Faculty Management</h2>
            {% if user.role == 'admin' %}
            <div class="d-flex flex-wrap gap-2">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-download"></i> Download Template
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/download-template/faculty?format=csv">CSV</a></li>
                        <li><a class="dropdown-item" href="/download-template/faculty?format=xlsx">Excel (.xlsx)</a>
                        </li>
                    </ul>
                </div>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#importFacultyModal">
                    <i class="bi bi-upload"></i> Import CSV/Excel
                </button>
                <button class="btn btn-outline-danger" onclick="deleteAllFaculty(event)">
                    <i class="bi bi-trash"></i> Delete All
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFacultyModal">
                    <i class="bi bi-plus-circle"></i> Add Faculty
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Username</th>
                            <th>Workload (min-max)</th>
                            <th>Expertise</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for f in faculty %}
                        <tr>
                            <td><strong>{{ f.name }}</strong></td>
                            <td>{{ f.email or '-' }}</td>
                            <td>{{ f.username or '—' }}</td>
                            <td>{{ f.min_hours_per_week or 0 }} - {{ f.max_hours_per_week or 0 }} hrs</td>
                            <td>
                                {% if f.expertise %}
                                {% for code in f.expertise.split(',') %}
                                <span class="badge bg-secondary">{{ code.strip() }}</span>
                                {% endfor %}
                                {% else %}
                                <span class="text-muted">None specified</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.role == 'admin' %}
                                <button class="btn btn-sm btn-danger" onclick="deleteFaculty({{ f.id }})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                                {% else %}
                                <span class="text-muted">View Only</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">No faculty added yet. Click "Add Faculty" to
                                get started.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Faculty Modal -->
<div class="modal fade" id="addFacultyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Faculty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addFacultyForm">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expertise (Course Codes)</label>
                        <small class="text-muted d-block mb-2">Select course codes this faculty can teach
                            (comma-separated or select from list)</small>
                        <div class="mb-2">
                            <input type="text" class="form-control" name="expertise_text"
                                placeholder="e.g., CS101, CS102, MATH201">
                        </div>
                        <div>
                            <small>Available courses:</small>
                            <div class="mt-1">
                                {% for course in courses %}
                                <span class="badge bg-light text-dark me-1 mb-1" style="cursor: pointer;"
                                    onclick="addExpertise('{{ course.code }}')">{{ course.code }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Login Username *</label>
                        <small class="text-muted d-block mb-1">Faculty will use this username on the login
                            screen.</small>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Temporary Password</label>
                        <small class="text-muted d-block mb-1">Leave blank to auto-generate and reveal after
                            save.</small>
                        <input type="text" class="form-control" name="password" placeholder="Optional initial password">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Min Hours / Week</label>
                            <input type="number" class="form-control" name="min_hours_per_week" value="4" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Hours / Week</label>
                            <input type="number" class="form-control" name="max_hours_per_week" value="16" min="1">
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> <strong>Note:</strong> Faculty must be available for at least
                        <strong>70% of total periods</strong> to ensure adequate scheduling. You can set availability
                        after creation in the timetable view.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitFaculty()">Add Faculty</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importFacultyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Faculty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importFacultyForm">
                    <div class="mb-3">
                        <label class="form-label">CSV/Excel File *</label>
                        <input type="file" class="form-control" name="file" accept=".csv,.xls,.xlsx" required>
                    </div>
                    <p class="text-muted small mb-0">Required columns: name, username. Optional: email, expertise,
                        password, min_hours_per_week, max_hours_per_week, availability.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importFaculty()">Import</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let expertiseList = [];

    function addExpertise(code) {
        if (!expertiseList.includes(code)) {
            expertiseList.push(code);
            updateExpertiseDisplay();
        }
    }

    function updateExpertiseDisplay() {
        const input = document.querySelector('input[name="expertise_text"]');
        input.value = expertiseList.join(', ');
    }

    function submitFaculty() {
        const form = document.getElementById('addFacultyForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        // Combine expertise from list and text input
        const expertiseText = data.expertise_text || '';
        const expertise = expertiseList.length > 0 ? expertiseList : (expertiseText ? expertiseText.split(',').map(c => c.trim()) : []);

        const payload = {
            name: data.name,
            email: data.email || '',
            expertise: expertise,
            availability: '{}',
            username: data.username,
            password: data.password || '',
            min_hours_per_week: data.min_hours_per_week || 4,
            max_hours_per_week: data.max_hours_per_week || 16
        };

        fetch('/faculty/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (data.generated_password) {
                        alert(`✓ Faculty added successfully!\n\nAuto-generated password for ${payload.username}: ${data.generated_password}\n\nPlease share this with the faculty member securely.`);
                    } else {
                        alert('✓ Faculty added successfully!');
                    }
                    location.reload();
                } else {
                    alert('❌ Error: ' + (data.error || 'Failed to add faculty'));
                }
            })
            .catch(err => {
                alert('❌ Network error: ' + err.message);
            });
    }

    function deleteFaculty(id) {
        if (!confirm('Are you sure you want to delete this faculty member?')) return;

        fetch(`/faculty/${id}/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting faculty');
                }
            });
    }

    function deleteAllFaculty(event) {
        event.preventDefault();
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';

        fetch('/faculty/delete-all', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
            credentials: 'same-origin'
        })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (ct.includes('application/json')) return response.json();
                return response.text().then(text => { throw new Error('Non-JSON response'); });
            })
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    console.error('Error:', data.error);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                console.error('Error:', err);
            });
    }


    function importFaculty() {
        const form = document.getElementById('importFacultyForm');
        const formData = new FormData(form);
        fetch('/faculty/import', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Import failed: ' + (data.error || 'Unknown error'));
                }
            });
    }
</script>
{% endblock %}