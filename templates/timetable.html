{% extends "base.html" %}

{% block title %}Timetable - Plansphere.ai{% endblock %}

{% block content %}
{% if user.role == 'teacher' %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> My Availability</h5>
                <button class="btn btn-sm btn-light" onclick="saveAvailability()">
                    <i class="bi bi-save"></i> Save Availability
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle"></i> Select the periods you are available to teach. The intelligent
                    scheduler will only assign you during these times.
                </p>
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong> You must be available for at
                    least <strong>70% of total periods</strong> to ensure proper scheduling.
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th width="15%">Day</th>
                                <th>Available Periods</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in days %}
                            <tr>
                                <td class="fw-bold">{{ day }}</td>
                                <td>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for period in periods %}
                                        <div class="form-check">
                                            <input class="form-check-input availability-checkbox" type="checkbox"
                                                id="availability-{{ day }}-{{ period }}" data-day="{{ day }}"
                                                value="{{ period }}">
                                            <label class="form-check-label" for="availability-{{ day }}-{{ period }}">
                                                P{{ period }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="page-title"><i class="bi bi-calendar-week"></i> Timetable</h2>
            <div>
                {% if user.role == 'admin' %}
                <button class="btn btn-success me-2" onclick="generateTimetable(event)">
                    <i class="bi bi-magic"></i> Generate Timetable
                </button>
                {% endif %}
                {% if timetable_data %}
                <a href="/timetable/export" class="btn btn-primary">
                    <i class="bi bi-download"></i> Export CSV
                </a>
                {% if user.role == 'admin' %}
                <button class="btn btn-danger ms-2" onclick="clearTimetable()">
                    <i class="bi bi-trash"></i> Clear
                </button>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if warnings %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Generation Warnings</h5>
            <ul class="mb-0">
                {% for warning in warnings %}
                <li>{{ warning }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endif %}

{% if workload_report %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Faculty Workload Report</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Faculty</th>
                                <th>Assigned Hours</th>
                                <th>Min-Max Range</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in workload_report %}
                            <tr>
                                <td>
                                    <strong>{{ report.name }}</strong>
                                    {% if report.is_senior %}
                                    <span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i>
                                        Senior</span>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-info">{{ report.assigned_hours }} hrs</span></td>
                                <td>{{ report.min_hours }} - {{ report.max_hours }} hrs</td>
                                <td>
                                    {% if report.assigned_hours > 40 %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle-fill"></i> Overworked ({{
                                        report.assigned_hours }}hrs)
                                    </span>
                                    {% elif report.assigned_hours > report.max_hours %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-exclamation-circle"></i> Above Max
                                    </span>
                                    {% elif report.assigned_hours < report.min_hours %} <span
                                        class="badge bg-secondary">
                                        <i class="bi bi-dash-circle"></i> Below Min
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Optimal
                                        </span>
                                        {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if timetable_data %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Generated Timetable</h5>
                    {% if student_groups %}
                    {% if user.role == 'admin' %}
                    <div class="form-check form-switch ms-3 d-inline-block">
                        <input class="form-check-input" type="checkbox" id="manualAssignToggle"
                            onchange="toggleManualAssign(this)">
                        <label class="form-check-label" for="manualAssignToggle">Manual Assignments (Class
                            columns)</label>
                    </div>
                    {% endif %}
                    <select class="form-select" style="width: auto;" id="groupFilter" onchange="filterByGroup()">
                        <option value="">All Groups</option>
                        {% for group in student_groups %}
                        <option value="{{ group.name }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <div id="manualAssignContainer" style="display:none;">
                        <div class="mb-2 d-flex align-items-center gap-2">
                            <label class="form-label mb-0">Day:</label>
                            <select id="manualDay" class="form-select" style="width:auto;"
                                onchange="renderManualTable()">
                                {% for day in days %}
                                <option value="{{ day }}">{{ day }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-primary ms-2" onclick="saveManualAssignments()">Save
                                Assignments</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm mb-0" id="manualTable">
                                <!-- Will be rendered by JS -->
                            </table>
                        </div>
                    </div>

                    <table class="table table-bordered table-sm mb-0" id="standardTable">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" width="10%">Time</th>
                                {% for day in days %}
                                <th class="text-center">{{ day }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for period in periods %}
                            <tr>
                                <td class="fw-bold text-center"
                                    style="background: var(--bg-card); border-right: 2px solid var(--border-color);">
                                    <div style="color: var(--text-primary); font-size: 1rem;">Period {{ period }}</div>
                                    {% if time_ranges and period in time_ranges %}
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">{{
                                        time_ranges[period] }}</small>
                                    {% endif %}
                                </td>
                                {% for day in days %}
                                <td class="p-2">
                                    {% set found_entries = [] %}
                                    {% for key, entries in timetable_data.items() %}
                                    {% if key[0] == day and key[1] == period %}
                                    {% for entry in entries %}
                                    {% set _ = found_entries.append(entry) %}
                                    {% endfor %}
                                    {% endif %}
                                    {% endfor %}
                                    {% if found_entries %}
                                    {% for entry in found_entries %}
                                    <div class="timetable-cell mb-2" data-group="{{ entry.student_group }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <strong class="text-primary">{{ entry.course.code }}</strong>
                                            {% if entry.student_group %}
                                            <span class="badge bg-secondary">{{ entry.student_group }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-truncate" title="{{ entry.course.name }}">
                                            <small>{{ entry.course.name[:30] }}{% if entry.course.name|length > 30
                                                %}...{% endif %}</small>
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            <i class="bi bi-person"></i> {{ entry.faculty.name }}<br>
                                            <i class="bi bi-building"></i> {{ entry.room.name }}
                                            {% if entry.course.course_type == 'practical' %}
                                            <span class="badge bg-warning text-dark ms-1">Lab</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% if period in break_map %}
                            <tr class="table-warning">
                                <td class="fw-bold text-center">
                                    <i class="bi bi-cup-hot"></i><br>
                                    {{ break_map[period].break_name }}<br>
                                    <small>{{ break_map[period].duration_minutes }} min</small>
                                </td>
                                {% for day in days %}
                                <td class="text-center bg-warning bg-opacity-25">
                                    <strong>{{ break_map[period].break_name }}</strong><br>
                                    <small class="text-muted">{{ break_map[period].duration_minutes }} minutes</small>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="info-box">
            <h6><i class="bi bi-info-circle"></i> Legend</h6>
            <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-secondary">Group</span>
                <span class="badge bg-warning text-dark">Lab Session</span>
                <span class="badge bg-danger">Overworked (40+ hrs)</span>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="success-box">
            <h6><i class="bi bi-check-circle"></i> Intelligent Features Active</h6>
            <small>✓ Workload balanced | ✓ Labs prioritized | ✓ Availability respected | ✓ No consecutive
                duplicates</small>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">No Timetable Generated</h4>
                <p class="text-muted">
                    {% if user.role == 'admin' %}
                    Click "Generate Timetable" to create an intelligent, conflict-free schedule with automatic workload
                    management.
                    {% else %}
                    No timetable has been generated yet. Please contact an administrator.
                    {% endif %}
                </p>
                {% if user.role == 'admin' %}
                <button class="btn btn-primary btn-lg" onclick="generateTimetable(event)">
                    <i class="bi bi-magic"></i> Generate Intelligent Timetable
                </button>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-lightbulb"></i> Make sure you've configured constraints in
                        <a href="/constraints">Scheduling Constraints</a> page
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const teacherAvailability = {{ teacher_availability| tojson | safe }};

    document.addEventListener('DOMContentLoaded', () => {
        if (teacherAvailability && Object.keys(teacherAvailability).length) {
            document.querySelectorAll('.availability-checkbox').forEach(cb => {
                const day = cb.dataset.day;
                const period = parseInt(cb.value, 10);
                if (teacherAvailability[day] && teacherAvailability[day].includes(period)) {
                    cb.checked = true;
                }
            });
        }
    });

    function generateTimetable(evt) {
        if (!confirm('Generate a new intelligent timetable?\n\n✓ Automatic workload management\n✓ Lab priority allocation\n✓ Faculty availability respect\n✓ Smart lecture scheduling\n✓ Overwork detection\n\nExisting timetable will be replaced. Continue?')) {
            return;
        }

        const btn = evt ? evt.target.closest('button') : null;
        const originalText = btn ? btn.innerHTML : '';
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
        }

        fetch('/timetable/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(r => r.json())
            .then(data => {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }

                if (data.success) {
                    let message = '✓ ' + data.message;
                    if (data.warnings && data.warnings.length > 0) {
                        message += '\n\n⚠ Warnings:\n' + data.warnings.join('\n');
                    }
                    alert(message);
                    location.reload();
                } else {
                    alert('✗ Error: ' + (data.message || 'Failed to generate timetable'));
                    if (data.warnings && data.warnings.length > 0) {
                        console.warn('Warnings:', data.warnings);
                    }
                }
            })
            .catch(err => {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
                alert('✗ Error: ' + err.message);
            });
    }

    function clearTimetable() {
        if (!confirm('Are you sure you want to clear the timetable? This cannot be undone.')) return;

        fetch('/timetable/clear', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('✓ Timetable cleared successfully.');
                    location.reload();
                } else {
                    alert('✗ Error clearing timetable');
                }
            });
    }

    function saveAvailability() {
        const payload = {};
        document.querySelectorAll('.availability-checkbox').forEach(cb => {
            const day = cb.dataset.day;
            const period = parseInt(cb.value, 10);
            if (!payload[day]) {
                payload[day] = [];
            }
            if (cb.checked) {
                payload[day].push(period);
            }
        });

        fetch('/faculty/availability', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ availability: payload })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const message = data.message || '✓ Availability saved successfully!\n\nYour schedule will be respected in the next timetable generation.';
                    alert(message);
                } else {
                    alert('❌ Failed to save availability:\n\n' + (data.error || 'Unknown error') + '\n\nPlease ensure you are available for at least 70% of total periods.');
                }
            })
            .catch(err => {
                alert('❌ Network error: ' + err.message);
            });
    }

    function filterByGroup() {
        const selectedGroup = document.getElementById('groupFilter').value;
        const cells = document.querySelectorAll('.timetable-cell');

        cells.forEach(cell => {
            if (selectedGroup === '' || cell.dataset.group === selectedGroup) {
                cell.style.display = 'block';
            } else {
                cell.style.display = 'none';
            }
        });
    }

    // Manual Assignments logic
    const COURSES = {{ courses| tojson | safe }};
    const FACULTY = {{ faculty| tojson | safe }};
    const ROOMS = {{ rooms| tojson | safe }};
    const GROUPS = {{ student_groups| tojson | safe }};

    function toggleManualAssign(el) {
        const on = el.checked;
        document.getElementById('manualAssignContainer').style.display = on ? 'block' : 'none';
        document.getElementById('standardTable').style.display = on ? 'none' : 'table';
        if (on) renderManualTable();
    }

    function renderManualTable() {
        const day = document.getElementById('manualDay').value;
        const table = document.getElementById('manualTable');
        // build header: Period + groups
        let html = '<thead class="table-light"><tr><th width="8%">Period</th>';
        GROUPS.forEach(g => { html += `<th class="text-center">${g.name}</th>`; });
        html += '</tr></thead>';
        html += '<tbody>';
        const periods = {{ periods| tojson | safe
    }};
    periods.forEach(period => {
        html += `<tr><td class="fw-bold text-center bg-light">P${period}</td>`;
        GROUPS.forEach(g => {
            // each cell: selects for course, faculty, room
            const cellId = `cell-${day}-${period}-${g.name}`.replace(/\s+/g, '_');
            let courseOptions = `<option value="">(none)</option>`;
            COURSES.forEach(c => { courseOptions += `<option value="${c.id}">${c.code} - ${c.name}</option>`; });

            let facultyOptions = `<option value="">(none)</option>`;
            FACULTY.forEach(f => { facultyOptions += `<option value="${f.id}">${f.name}</option>`; });

            let roomOptions = `<option value="">(none)</option>`;
            ROOMS.forEach(r => { roomOptions += `<option value="${r.id}">${r.name}</option>`; });

            html += `<td class="p-2">
                <div class="mb-1">
                    <select class="form-select form-select-sm manual-course" data-day="${day}" data-period="${period}" data-group="${g.name}" id="${cellId}-course">${courseOptions}</select>
                </div>
                <div class="mb-1">
                    <select class="form-select form-select-sm manual-faculty" data-day="${day}" data-period="${period}" data-group="${g.name}" id="${cellId}-faculty">${facultyOptions}</select>
                </div>
                <div>
                    <select class="form-select form-select-sm manual-room" data-day="${day}" data-period="${period}" data-group="${g.name}" id="${cellId}-room">${roomOptions}</select>
                </div>
            </td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    table.innerHTML = html;

    // Optionally pre-fill with existing timetable entries for this day
    fetch(`/timetable/entries?day=${encodeURIComponent(day)}`)
        .then(r => r.json())
        .then(data => {
            if (!data.entries) return;
            data.entries.forEach(e => {
                const idBase = `cell-${day}-${e.period}-${e.student_group}`.replace(/\s+/g, '_');
                const csel = document.getElementById(idBase + '-course');
                const fsel = document.getElementById(idBase + '-faculty');
                const rsel = document.getElementById(idBase + '-room');
                if (csel) csel.value = e.course_id || '';
                if (fsel) fsel.value = e.faculty_id || '';
                if (rsel) rsel.value = e.room_id || '';
            });
        }).catch(() => { });
}

    function saveManualAssignments() {
        const day = document.getElementById('manualDay').value;
        const assignments = [];
        document.querySelectorAll('.manual-course').forEach(select => {
            const period = select.dataset.period;
            const group = select.dataset.group;
            const course_id = select.value || null;
            const facultySel = document.getElementById(`${select.id.replace('-course', '')}-faculty`);
            const roomSel = document.getElementById(`${select.id.replace('-course', '')}-room`);
            const faculty_id = facultySel ? (facultySel.value || null) : null;
            const room_id = roomSel ? (roomSel.value || null) : null;
            assignments.push({ period: period, group: group, course_id: course_id, faculty_id: faculty_id, room_id: room_id });
        });

        fetch('/timetable/manual-save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ day: day, assignments: assignments })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Assignments saved. ' + (data.processed || 0) + ' items.');
                    if (data.warnings) alert('Warnings:\n' + data.warnings.join('\n'));
                    location.reload();
                } else {
                    alert('Save failed: ' + (data.error || 'Unknown error'));
                }
            }).catch(err => alert('Save error: ' + err.message));
    }
</script>
{% endblock %}