{% extends "base.html" %}

{% block title %}Manage Courses - Plansphere.ai{% endblock %}

{% block content %}
<style>
    /* Hierarchical Course Management Styles */
    .search-bar {
        position: relative;
        margin-bottom: 2rem;
    }

    .search-bar input {
        padding-left: 2.5rem;
        border-radius: 8px;
    }

    .search-bar i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    .program-section {
        margin-bottom: 3rem;
    }

    .program-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: #2c3e50;
    }

    .branch-card {
        position: relative;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .branch-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .branch-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
    }

    .branch-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin-right: 1rem;
    }

    .branch-info h5 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .branch-info p {
        color: #6c757d;
        margin: 0;
        font-size: 0.9rem;
    }

    .branch-meta {
        text-align: right;
    }

    .branch-meta small {
        display: block;
        color: #6c757d;
    }

    .delete-branch {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: #dc3545;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .branch-card:hover .delete-branch {
        opacity: 1;
    }

    .semester-accordion {
        margin-top: 1rem;
        display: none;
    }

    .semester-accordion.show {
        display: block;
    }

    .semester-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: #f8f9fa;
    }

    .semester-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

    .semester-courses {
        margin-top: 1rem;
        display: none;
    }

    .semester-courses.show {
        display: block;
    }

    .course-item {
        background: white;
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        border-left: 3px solid #667eea;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .course-item .course-code {
        font-weight: 600;
        color: #2c3e50;
    }

    .course-item .course-name {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .course-badge {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
    }

    .filter-dropdown {
        min-width: 150px;
    }
</style>

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="gradient-text"><i class="bi bi-book"></i> Manage Courses</h2>
            {% if user.role == 'admin' %}
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                    <i class="bi bi-plus-circle"></i> Add Course
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-download"></i> Download Template
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/download-template/courses?format=csv">CSV</a></li>
                        <li><a class="dropdown-item" href="/download-template/courses?format=xlsx">Excel (.xlsx)</a>
                        </li>
                    </ul>
                </div>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#importCourseModal">
                    <i class="bi bi-upload"></i> Import CSV/Excel
                </button>
                <button class="btn btn-outline-danger" onclick="deleteAllCourses(event)">
                    <i class="bi bi-trash"></i> Delete All
                </button>
            </div>
            {% endif %}
        </div>
        <p class="text-muted">Add, edit, and organize all available degree programs and branches.</p>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" class="form-control" id="searchInput" placeholder="Search by branch or course code..."
                onkeyup="filterCourses()">
        </div>
    </div>
    <div class="col-md-4">
        <select class="form-select filter-dropdown" id="degreeFilter" onchange="filterCourses()">
            <option value="">Filter by Degree</option>
            {% for program_name in hierarchy.keys() %}
            <option value="{{ program_name }}">{{ program_name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Hierarchical Course Display -->
{% for program_name, program_data in hierarchy.items() %}
<div class="program-section" data-program="{{ program_name }}">
    <h3 class="program-title">{{ program_name }}</h3>

    <div class="row">
        {% for branch_name, branch_data in program_data.branches.items() %}
        <div class="col-md-6 col-lg-4 branch-container" data-branch="{{ branch_name }}">
            <div class="branch-card" onclick="toggleBranchExpand(this)">
                <div class="branch-card-header">
                    <div class="d-flex align-items-center">
                        <div class="branch-icon">
                            <i class="bi bi-laptop"></i>
                        </div>
                        <div class="branch-info">
                            <h5>{{ branch_name }}</h5>
                            <p>{{ branch_data.code }}</p>
                            <p class="text-muted mb-0">4-Year Program</p>
                        </div>
                    </div>
                    <div class="branch-meta">
                        {% if branch_data.hod %}
                        <small>HOD: {{ branch_data.hod }}</small>
                        {% endif %}
                        <small><strong>{{ branch_data.semesters|length }} Semesters</strong></small>
                        {% if branch_data.total_students > 0 %}
                        <small>{{ branch_data.total_students }} Students</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Semester Accordion -->
                <div class="semester-accordion">
                    {% for semester, courses_list in branch_data.semesters.items() %}
                    <div class="semester-item">
                        <div class="semester-header" onclick="event.stopPropagation(); toggleSemester(this)">
                            <strong>Semester {{ semester }}</strong>
                            <span class="badge bg-secondary">{{ courses_list|length }} Courses</span>
                        </div>
                        <div class="semester-courses">
                            {% for course in courses_list %}
                            <div class="course-item">
                                <div>
                                    <div class="course-code">{{ course.code }}</div>
                                    <div class="course-name">{{ course.name }}</div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="course-badge">{{ course.credits }} Credits</span>
                                    {% if user.role == 'admin' %}
                                    <button class="btn btn-sm btn-danger"
                                        onclick="event.stopPropagation(); deleteCourse({{ course.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No courses added yet. Click "Add Course" to get started.
</div>
{% endfor %}

<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCourseForm">
                    <div class="mb-3">
                        <label class="form-label">Program *</label>
                        <input type="text" class="form-control" name="program" placeholder="e.g., B.Tech" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Branch *</label>
                        <input type="text" class="form-control" name="branch" placeholder="e.g., Computer Science"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Semester *</label>
                        <select class="form-select" name="semester" required>
                            <option value="">Select Semester</option>
                            {% for i in range(1, 9) %}
                            <option value="{{ i }}">Semester {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Course Code *</label>
                        <input type="text" class="form-control" name="code" placeholder="e.g., CS101" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Course Name *</label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., Data Structures"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Credits *</label>
                        <input type="number" class="form-control" name="credits" min="1" max="10" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Course Type *</label>
                        <select class="form-select" name="type" required>
                            <option value="theory">Theory</option>
                            <option value="practical">Practical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hours Per Week *</label>
                        <input type="number" class="form-control" name="hours_per_week" min="1" max="10" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Required Lab Tags</label>
                        <input type="text" class="form-control" name="required_room_tags" placeholder="computer, iot">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCourse()">Add Course</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Courses</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importCourseForm">
                    <div class="mb-3">
                        <label class="form-label">CSV/Excel File *</label>
                        <input type="file" class="form-control" name="file" accept=".csv,.xls,.xlsx" required>
                    </div>
                    <p class="text-muted small">Required columns: program, branch, semester, code, name, credits,
                        hours_per_week, type</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importCourses()">Import</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleBranchExpand(card) {
        const accordion = card.querySelector('.semester-accordion');
        const wasShown = accordion.classList.contains('show');

        // Close all other accordions
        document.querySelectorAll('.semester-accordion.show').forEach(acc => {
            if (acc !== accordion) {
                acc.classList.remove('show');
            }
        });

        // Toggle current
        if (wasShown) {
            accordion.classList.remove('show');
        } else {
            accordion.classList.add('show');
        }
    }

    function toggleSemester(header) {
        const coursesDiv = header.nextElementSibling;
        coursesDiv.classList.toggle('show');
    }

    function filterCourses() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const degreeFilter = document.getElementById('degreeFilter').value;

        document.querySelectorAll('.program-section').forEach(section => {
            const programName = section.getAttribute('data-program');
            let programVisible = false;

            // Check degree filter
            if (degreeFilter && programName !== degreeFilter) {
                section.style.display = 'none';
                return;
            }

            section.querySelectorAll('.branch-container').forEach(container => {
                const branchName = container.getAttribute('data-branch').toLowerCase();
                const courseItems = container.querySelectorAll('.course-item');
                let branchVisible = false;

                courseItems.forEach(item => {
                    const courseCode = item.querySelector('.course-code').textContent.toLowerCase();
                    const courseName = item.querySelector('.course-name').textContent.toLowerCase();

                    if (courseCode.includes(searchTerm) || courseName.includes(searchTerm) || branchName.includes(searchTerm)) {
                        item.style.display = 'flex';
                        branchVisible = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                container.style.display = branchVisible ? 'block' : 'none';
                if (branchVisible) programVisible = true;
            });

            section.style.display = programVisible ? 'block' : 'none';
        });
    }

    function submitCourse() {
        const form = document.getElementById('addCourseForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        fetch('/courses/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    UI.showToast('Course added successfully', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    UI.showToast('Error: ' + (data.error || 'Failed to add course'), 'error');
                }
            });
    }

    function deleteCourse(id) {
        if (!confirm('Are you sure you want to delete this course?')) return;

        fetch(`/courses/${id}/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    UI.showToast('Course deleted', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    UI.showToast('Error deleting course', 'error');
                }
            });
    }

    function importCourses() {
        const form = document.getElementById('importCourseForm');
        const formData = new FormData(form);
        const modal = bootstrap.Modal.getInstance(document.getElementById('importCourseModal'));
        modal.hide();

        fetch('/courses/import', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    UI.showToast('Courses imported successfully', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    UI.showToast('Import failed: ' + (data.error || 'Unknown error'), 'error');
                }
            });
    }

    function deleteAllCourses(event) {
        event.preventDefault();
        if (!confirm('Are you sure you want to delete ALL courses? This cannot be undone.')) return;

        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';

        fetch('/courses/delete-all', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    UI.showToast(`Deleted ${data.deleted} courses`, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    UI.showToast('Error: ' + data.error, 'error');
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                UI.showToast('Error: ' + err, 'error');
            });
    }
</script>
{% endblock %}